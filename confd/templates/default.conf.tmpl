{{range $domain := lsdir "/"}}
server {
  {{$url := split (base $domain) ":"}}
    listen       {{index $url 1}};
    server_name  {{index $url 0}};
  {{$basedir := printf "/%s/*" $domain}}
  {{range gets $basedir}}
    {{base .Key}} {{.Value}};
  {{end}}

  {{$basedir := printf "/%s" $domain}}
  {{range $location_id := lsdir $basedir}}
    {{$location_key :=  printf "/%s/%s/location" $domain $location_id}}
    {{$propertiesdir := printf "/%s/%s/properties/*" $domain $location_id}}
    {{$proxy_set_headerdir :=printf "/%s/%s/proxy_set_header/*" $domain $location_id}}
    location  {{getv $location_key}} {
      {{range gets $propertiesdir}}
        {{base .Key}} {{.Value}};
      {{end}}
      {{range gets $proxy_set_headerdir}}
        proxy_set_header {{base .Key}} {{.Value}};
      {{end}}
    }
  {{end}}
}
{{end}}
